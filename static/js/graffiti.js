(()=>{
    let nossika_str = `[{"shape":"line","width":"6","stroke":"rgba(192,128,128,0.8)","fill":"rgba(55,33,222,0)","points":[[132,76],[130,81],[127,87],[126,93],[123,101],[121,109],[117,122],[114,128],[113,136],[111,142],[108,148],[104,157],[101,165],[99,173],[96,179],[95,184],[93,188],[90,197],[88,204],[87,207],[86,210],[85,213],[85,214],[84,216],[82,220],[81,221],[80,222],[80,223],[79,226],[79,227],[79,221],[82,213]]},{"shape":"line","width":"6","stroke":"rgba(192,128,128,0.8)","fill":"rgba(55,33,222,0)","points":[[133,84],[134,84],[135,87],[136,91],[137,96],[140,102],[142,107],[145,113],[147,119],[150,127],[154,134],[158,145],[160,148],[161,151],[162,154],[164,158],[164,159],[165,159],[166,160],[167,162],[168,163],[169,165],[169,166],[170,168],[172,171],[173,172],[174,173],[175,175],[176,177],[177,177],[178,178],[179,179],[179,181],[180,181],[180,182],[181,183],[182,184],[183,186],[184,186],[184,188],[185,189],[186,190],[187,191],[188,192],[188,193],[189,194],[190,196],[190,197],[191,198],[192,201],[193,202],[193,204],[193,205],[194,206],[194,207],[195,207],[195,208],[195,209],[196,210],[197,207],[198,203],[199,198],[200,191],[202,183],[203,175],[204,167],[205,159],[207,155],[208,149],[209,144],[210,140],[211,137],[212,134],[213,132],[214,130],[215,127],[216,124],[217,121],[218,118],[219,115],[221,112],[222,108],[223,107],[224,103],[225,102],[226,100],[227,98],[228,97],[229,94],[230,91],[232,88],[233,86],[234,84],[235,83],[235,82]]},{"shape":"line","width":"6","stroke":"rgba(192,128,128,0.8)","fill":"rgba(55,33,222,0)","points":[[306,152],[306,151],[304,151],[302,151],[300,151],[297,152],[294,153],[291,155],[285,159],[283,162],[281,164],[279,166],[277,168],[276,170],[275,172],[274,174],[273,177],[272,180],[271,183],[270,186],[269,188],[268,191],[267,193],[267,195],[267,196],[267,197],[267,199],[267,201],[268,204],[269,208],[273,211],[276,212],[278,213],[281,214],[289,216],[297,218],[303,218],[307,218],[316,215],[323,212],[327,210],[330,208],[333,205],[335,203],[336,200],[337,198],[338,197],[339,196],[339,195],[339,193],[340,192],[340,191],[341,189],[341,187],[341,186],[341,185],[341,184],[341,183],[341,182],[341,181],[340,179],[339,177],[337,173],[336,170],[335,167],[334,164],[333,161],[332,159],[331,157],[330,156],[329,155],[328,154],[328,153],[327,152],[326,151],[325,151],[324,149],[323,148],[322,148],[321,147],[320,146],[320,145],[319,145],[318,144],[316,144],[316,143],[315,143],[314,143],[313,142],[311,142],[310,142],[308,142],[307,142],[306,142],[305,142],[305,143],[305,144]]},{"shape":"line","width":"6","stroke":"rgba(192,128,128,0.8)","fill":"rgba(55,33,222,0)","points":[[431,139],[429,138],[427,137],[425,137],[421,137],[419,137],[418,137],[417,137],[416,137],[415,138],[414,138],[413,138],[412,139],[412,140],[410,140],[408,143],[407,144],[406,145],[405,146],[404,148],[403,150],[403,152],[403,154],[403,155],[403,156],[403,157],[403,159],[404,160],[405,160],[406,161],[406,162],[408,163],[410,164],[412,165],[417,167],[423,169],[426,171],[427,172],[428,172],[430,173],[430,174],[431,175],[432,176],[432,177],[433,178],[434,179],[434,181],[434,183],[434,186],[433,189],[432,191],[430,194],[429,197],[428,199],[424,201],[421,202],[420,204],[418,205],[417,205],[415,206],[414,206],[411,206],[410,206],[407,206],[404,206],[403,205],[402,205],[401,205],[400,205],[400,204],[399,204],[398,204],[397,204],[396,204]]},{"shape":"line","width":"6","stroke":"rgba(192,128,128,0.8)","fill":"rgba(55,33,222,0)","points":[[519,143],[517,142],[516,142],[515,142],[513,142],[512,142],[511,142],[510,142],[508,142],[507,141],[505,141],[502,140],[500,140],[499,140],[497,140],[496,140],[495,140],[494,140],[493,140],[492,141],[489,143],[487,148],[486,151],[485,154],[484,156],[483,158],[482,160],[481,164],[481,166],[481,167],[482,169],[483,170],[484,172],[487,173],[490,175],[493,177],[496,178],[499,179],[504,180],[507,181],[513,183],[514,185],[515,186],[516,186],[517,187],[517,188],[517,190],[517,191],[517,192],[517,195],[516,198],[514,201],[514,202],[509,204],[507,205],[504,206],[500,208],[498,209],[497,209],[495,209],[493,209],[489,209],[487,209],[486,209],[484,209],[483,209],[481,208],[480,207],[479,207],[479,206],[478,204],[477,204],[476,203],[475,201]]},{"shape":"line","width":"6","stroke":"rgba(192,128,128,0.8)","fill":"rgba(55,33,222,0)","points":[[580,145],[580,144],[580,145],[579,148],[578,152],[577,155],[576,158],[575,161],[574,164],[574,166],[573,169],[572,172],[572,173],[571,175],[570,177],[570,178],[570,179],[569,180],[569,181],[569,183],[568,185],[567,187],[567,188],[566,189],[566,190],[565,191],[565,192],[565,193],[564,194],[564,195],[564,196],[564,197],[563,197],[563,198],[563,199],[563,200],[563,201],[563,202],[562,202],[562,203],[562,204],[562,205],[562,206],[561,206]]},{"shape":"line","width":"6","stroke":"rgba(192,128,128,0.8)","fill":"rgba(55,33,222,0)","points":[[574,98],[575,98],[576,98],[577,98],[578,99],[580,101],[581,102],[582,102],[583,103],[583,104],[583,105],[583,106]]},{"shape":"line","width":"6","stroke":"rgba(192,128,128,0.8)","fill":"rgba(55,33,222,0)","points":[[670,79],[670,78],[670,81],[669,84],[668,87],[667,90],[666,94],[664,103],[662,111],[661,115],[659,122],[659,126],[658,129],[657,132],[656,135],[654,138],[653,143],[651,149],[650,152],[649,155],[648,158],[647,161],[646,164],[644,169],[642,174],[640,180],[639,182],[638,184],[636,189],[636,191],[635,193],[635,195],[634,196],[634,197],[633,198],[632,199],[631,200],[631,202],[631,203],[630,204],[629,204],[629,205],[628,206],[627,207],[627,208],[626,210],[626,212],[625,214],[628,210],[634,198],[643,184]]},{"shape":"line","width":"6","stroke":"rgba(192,128,128,0.8)","fill":"rgba(55,33,222,0)","points":[[715,92],[713,94],[707,101],[704,104],[700,107],[698,109],[695,110],[694,112],[693,114],[691,115],[690,117],[688,119],[686,121],[685,123],[683,125],[682,125],[680,127],[678,130],[677,131],[676,134],[673,137],[672,138],[670,140],[666,142],[666,143],[665,144],[664,144],[664,145],[663,146],[660,148],[660,149],[659,149],[658,150],[657,150],[658,153],[660,155],[662,157],[664,160],[666,163],[668,165],[669,167],[670,168],[672,170],[673,171],[675,173],[676,174],[677,175],[678,176],[680,177],[680,178],[681,179],[682,180],[684,181],[685,183],[687,185],[688,186],[689,187],[691,189],[692,189],[693,191],[695,193],[696,194],[697,195],[699,197],[700,198],[701,199],[702,200],[704,202],[706,204],[707,205],[707,206],[708,206],[709,207],[710,207],[710,208]]},{"shape":"line","width":"6","stroke":"rgba(192,128,128,0.8)","fill":"rgba(55,33,222,0)","points":[[824,155],[824,154],[823,154],[822,151],[822,150],[821,149],[820,149],[818,147],[817,145],[815,144],[814,142],[808,139],[806,138],[804,137],[802,136],[800,136],[797,134],[796,134],[795,134],[795,133],[794,133],[793,133],[792,133],[791,133],[790,133],[789,133],[788,133],[787,133],[786,134],[782,136],[776,143],[771,146],[768,150],[764,153],[762,156],[760,159],[759,161],[757,163],[754,167],[752,171],[751,172],[749,175],[748,178],[747,182],[747,187],[747,189],[747,192],[747,194],[747,195],[748,195],[750,196],[750,197],[753,199],[757,201],[761,202],[765,203],[768,205],[773,205],[775,205],[777,204],[781,203],[785,201],[788,199],[793,197],[797,194],[799,192],[806,186],[808,184],[809,183],[810,181],[811,177],[813,172],[815,168],[816,167],[818,165],[818,164],[818,163],[819,163],[819,162],[821,160],[821,159],[822,157],[822,156],[822,155],[822,154],[822,153],[822,152],[822,151],[822,155],[821,159],[819,165],[818,170],[817,173],[816,175],[816,176],[815,179],[814,180],[814,182],[814,183],[813,185],[813,186],[813,187],[813,188],[813,189],[813,191],[813,193],[813,195],[813,196],[814,198],[815,199],[817,201],[819,202],[819,203],[820,204],[821,204],[822,205],[822,206],[824,207],[825,207],[826,208],[827,208],[829,208],[830,209],[831,209],[833,209],[834,209],[837,209],[838,208],[840,206],[842,206],[844,205],[845,204],[846,203],[848,203]]}]`;

    GraffitiUtil.init_editor(document.querySelector('#graffiti-canvas').getContext('2d'));
    let controller = document.querySelector('.graffiti-controller');
    let canvas_board = document.querySelector('.graffiti-board');
    let status = document.querySelector('.graffiti-status');
    const FN = {
        update_btns: () => {
            let [stroke, fill, width, shape] = [
                GraffitiUtil.draw_stroke(),
                GraffitiUtil.draw_fill(),
                GraffitiUtil.draw_width(),
                GraffitiUtil.draw_shape(),
            ];

            let stroke_btn = controller.querySelector('[data-action="stroke"]');
            let stroke_none = Util.parse_rgba(stroke)[3] === 0;
            stroke_btn.style.backgroundColor = stroke_none ? '#fff' : stroke;
            stroke_btn.innerText = stroke_none ? 'X' : '';

            let fill_btn = controller.querySelector('[data-action="fill"]');
            let fill_none = Util.parse_rgba(fill)[3] === 0;
            fill_btn.style.backgroundColor = fill_none ? '#fff' : fill;
            fill_btn.innerText = fill_none ? 'X' : '';

            controller.querySelector('[data-action="width"]').innerHTML
                = FN.width_block_html(width);
            controller.querySelector('[data-action="shape"]').innerHTML
                = FN.shape_block_html(shape);

        },
        shape_block_html: (shape) => {
            return `
                <div class="shape-block" data-shape="${shape}">
                    <svg viewbox="0 0 1024 1024">
                        <use xlink:href="#svgpath_shape_${shape}"/>
                    </svg>
                </div>
            `
        },
        width_block_html: (width) => {
            return `
                <div class="line-block" style="position: relative" data-width="${width}">
                    <div style="height: ${width + "px"}; width: 100%"></div>
                </div>
            `
        },
        get_graffiti: (config, cb) => {
            Util.ajax({
                url: '/graffiti/list',
                data: {
                    limit: config.limit,
                    skip: config.skip || 0
                },
                method: 'get',
                callback: (d) => {
                    try {
                        d = JSON.parse(d);
                    } catch (e) {
                        d = null;
                    }
                    if(!d) return;
                
                    d.forEach((canvas_data) => {
                        let main_data = canvas_data.data,
                            time = Util.format_date(canvas_data.time);
                        if(!main_data) return;
                        let canvas = document.createElement('canvas'),
                            ctx = canvas.getContext('2d');
                        let text_h = 14;
                        let padding = 30;
                        let width = 300;

                        let [x_min, x_max, y_min, y_max] = GraffitiUtil.get_point_range(main_data);

                        x_min -= padding;
                        x_max += padding;
                        y_min -= padding;
                        y_max += padding;
                        let scale = width / (x_max - x_min);
                        scale = Math.min(scale, 1.2);
                        canvas.width = width;
                        canvas.height = scale * (y_max - y_min) + text_h + 10;
                        ctx.save();
                        ctx.scale(scale, scale);
                        ctx.translate(-x_min, -y_min);
                        GraffitiUtil.draw(main_data, ctx);
                        ctx.restore();
                        ctx.font = `${text_h}px/${text_h}px Microsoft YaHei`;
                        ctx.fillStyle = 'rgba(0,0,0,0.3)';
                        ctx.fillText(time, (+canvas.width - ctx.measureText(time).width) / 2, +canvas.height - 10);
                        canvas_board.appendChild(canvas);
                    });
                    Waterfall.fall(true);
                    cb && cb(d.length);
                }
            });
        },
        window_event: () => {
            window.scroll_fn['graffiti'] = () => {
                if(!document.querySelector('#graffiti')) return;
                if(window.scroll_fn['graffiti'].locked) return;
                let body = document.body;
                let list_count = canvas_board.querySelectorAll('canvas').length;
                if(!list_count || body.scrollTop + document.documentElement.clientHeight > body.scrollHeight - 150) {
                    window.scroll_fn['graffiti'].locked = true;
                    let lock_timer = setTimeout(() => {
                        window.scroll_fn['graffiti'].locked = false;
                    }, 3000);
                    status.innerText = 'loading...';
                    FN.get_graffiti({
                        limit: 30,
                        skip: list_count
                    }, (len) => {
                        if(len < 30) status.innerText = 'end';
                        window.scroll_fn['graffiti'].locked = false;
                        clearTimeout(lock_timer);
                    });
                }
            };
            Reflect.defineProperty(window.scroll_fn['graffiti'], 'locked', {
                value: false,
                writable: true
            });

            window.resize_fn['graffiti'] = () => {
                if(!document.querySelector('#graffiti')) return;
                Waterfall.fall();
            };
        }
    };
    (() => {//控制相关
        controller.querySelector('[data-action="shape"]').addEventListener('click', (e) => {
            let popup = Util.btn_popup(e, {w: 40, h: 240, mode: 0, offset: 5});

            ['line', 'straight', 'circle', 'rectangle', 'triangle', 'eraser'].forEach((shape) => {
                popup.innerHTML += FN.shape_block_html(shape);
            });

            popup.addEventListener('click', (e) => {
                let block = e.target;
                while(block !== popup && !block.getAttribute('data-shape')){
                    block = block.parentNode;
                }
                let shape = block.getAttribute('data-shape');
                if(!shape) return;
                GraffitiUtil.draw_shape(shape);
                FN.update_btns();
                popup.parentNode.removeChild(popup);
            });
            setTimeout(() => {
                document.body.appendChild(popup);
            }, 0);
        });

        controller.querySelector('[data-action="stroke"]').addEventListener('click', (e) => {
            let popup = Util.btn_popup(e, {w: 226, h: 346, mode: 0, offset: 5});
            popup.appendChild(ColorPicker.init({
                color_none: true,
                callbacks: {
                    onpick: (color) => {
                        GraffitiUtil.draw_stroke(`rgba(${color[0]},${color[1]},${color[2]},${color[3] === 0 ? 0 : 0.8})`);
                        FN.update_btns();
                        popup.parentNode.removeChild(popup);
                    }
                }
            }));
            setTimeout(() => {
                document.body.appendChild(popup);
            }, 0);
        });
        controller.querySelector('[data-action="fill"]').addEventListener('click', (e) => {
            let popup = Util.btn_popup(e, {w: 226, h: 346, mode: 0, offset: 5});
            popup.appendChild(ColorPicker.init({
                color_none: true,
                callbacks: {
                    onpick: (color) => {
                        GraffitiUtil.draw_fill(`rgba(${color[0]},${color[1]},${color[2]},${color[3] === 0 ? 0 : 0.8})`);
                        FN.update_btns();
                        popup.parentNode.removeChild(popup);
                    }
                }
            }));
            setTimeout(() => {
                document.body.appendChild(popup);
            }, 0);
        });
        controller.querySelector('[data-action="width"]').addEventListener('click', (e) => {
            let popup = Util.btn_popup(e, {w: 40, h: 200, mode: 0, offset: 5});

            [1, 2, 4, 6 ,8].forEach((width) => {
                popup.innerHTML += FN.width_block_html(width);
            });

            popup.addEventListener('click', (e) => {
                let block = e.target;
                while(block !== popup && !block.getAttribute('data-width')){
                    block = block.parentNode;
                }
                let width = block.getAttribute('data-width');
                if(!width) return;
                GraffitiUtil.draw_width(width);
                FN.update_btns();
                popup.parentNode.removeChild(popup);
            });
            setTimeout(() => {
                document.body.appendChild(popup);
            }, 0);
        });
        controller.querySelector('[data-action="download"]').addEventListener('click', () => {
            GraffitiUtil.download_png();
        });
        controller.querySelector('[data-action="undo"]').addEventListener('click', () => {
            GraffitiUtil.undo_paint();
        });
        controller.querySelector('[data-action="submit"]').addEventListener('click', () => {
            Util.ajax({
                url: '/graffiti/submit',
                data: {
                    data: JSON.stringify(GraffitiUtil.get_data())
                },
                method: 'post',
                callback: (d) => {
                    Waterfall.reset();
                    window.scroll_fn['graffiti']();
                }
            })
        });

        FN.update_btns();
    })();

    Waterfall.init(document.querySelector('.graffiti-board'), 'canvas', {
        space: [20, 20]
    });

    FN.window_event();
    window.scroll_fn['graffiti']();
})();
